# Shiplog v0.4.0-alpha — Trust, Signed

Date: 2025-10-06

This alpha focuses on making trust updates rock-solid across distros, clarifying enforcement, and giving you the tools to debug signature issues quickly.

## Highlights

- Gate Modes for Signed Trust: `commit | attestation | either` via `SHIPLOG_REQUIRE_SIGNED_TRUST_MODE`.
- Deep Debugging: `SHIPLOG_DEBUG_SSH_VERIFY=1` prints gate, mode, principals, payload tree OID, and per-signature results.
- Attestation E2E: Real `ssh-keygen -Y` signatures over the canonical trust payload with threshold enforcement.
- Robust Tests: “Signed trust push passes” is now green across the Docker matrix.

## Upgrade Notes

1) Install hooks via `hooksPath`
- Prefer Git’s `core.hooksPath` over symlinks. See `contrib/README.md` for instructions. The pre-receive hook reads env from a simple `hooks/env` file (exported automatically by wrapper scripts).

2) Choose a signature format
- `SHIPLOG_GPG_FORMAT=ssh` is recommended; OpenPGP is supported (`openpgp`). Ensure your fleet is consistent or pass `gpg.format` explicitly in CI and hooks.

3) Enable the trust-commit gate (recommended)
- Export `SHIPLOG_REQUIRE_SIGNED_TRUST=1` in the server hook environment to require the trust commit itself be signed. This is independent of your co-signing threshold.
- Pick a gate mode with `SHIPLOG_REQUIRE_SIGNED_TRUST_MODE`:
  - `commit` (default): trust commit must pass `git verify-commit`.
  - `attestation`: detached signatures in `.shiplog/trust_sigs/` must meet `threshold`.
  - `either`: accept commit or attestation (useful during migrations or when principal mapping varies by distro).

4) Attestation payload and back-compat
- The canonical payload signs the trust base tree (the OIDs of `trust.json` and `allowed_signers`).
- If you have older signatures over the full tree, set `SHIPLOG_ATTEST_BACKCOMP=1` in CI/hooks to verify both.

5) Policy validation and CI schema (from 0.3.0)
- `git shiplog policy validate` catches malformed policy locally.
- CI includes an AJV schema check for policy files (non-blocking by default).

## New/Changed Environment Variables

- `SHIPLOG_REQUIRE_SIGNED_TRUST_MODE` — `commit|attestation|either`.
- `SHIPLOG_DEBUG_SSH_VERIFY=1` — verbose trust verification logs.
- `SHIPLOG_ATTEST_BACKCOMP=1` — verify alternate payload (base vs full) for older signatures.

## Migration Tips

- On self-hosted Git, start with `REQUIRE_SIGNED_TRUST_MODE=either` to bridge principal differences (
  e.g., email vs wildcard). Tighten to `commit` or `attestation` once your allowed_signers and key distribution are solid.
- On SaaS hosts, enforce with a Required Status Check that runs the verifier script; include `SHIPLOG_DEBUG_SSH_VERIFY=1` on first rollout to capture diagnostics.

## Thanks

Big thanks to everyone who tested across distros and surfaced edge cases with `ssh-keygen -Y` principal handling. Your patience made this release sturdier.

