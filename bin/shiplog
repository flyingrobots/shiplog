#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_HOME="$(cd "$SCRIPT_DIR/.." && pwd)"
SHIPLOG_HOME="${SHIPLOG_HOME:-$DEFAULT_HOME}"
LIB_DIR="${SHIPLOG_LIB_DIR:-$SHIPLOG_HOME/lib}"

# -------- Config Defaults --------
REF_ROOT="${SHIPLOG_REF_ROOT:-refs/_shiplog}"
NOTES_REF="${SHIPLOG_NOTES_REF:-refs/_shiplog/notes/logs}"
DEFAULT_ENV="${SHIPLOG_ENV:-prod}"
AUTHOR_ALLOWLIST="${SHIPLOG_AUTHORS:-}"
ALLOWED_SIGNERS_FILE="${SHIPLOG_ALLOWED_SIGNERS:-.git/allowed_signers}"
GUM=${GUM:-gum}
SHIPLOG_BORING="${SHIPLOG_BORING:-0}"

for arg in "$@"; do
  if [ "$arg" = "--boring" ]; then
    SHIPLOG_BORING=1
    break
  fi
done
export SHIPLOG_BORING

POLICY_REF_DEFAULT="refs/_shiplog/policy/current"
POLICY_REF="${SHIPLOG_POLICY_REF:-$POLICY_REF_DEFAULT}"

SHIPLOG_POLICY_INITIALIZED=0
POLICY_SOURCE=""
POLICY_REQUIRE_SIGNED=""
POLICY_ALLOWED_SIGNERS_FILE=""
POLICY_ALLOWED_AUTHORS=""
POLICY_NOTES_REF=""
POLICY_JOURNALS_PREFIX=""
POLICY_ANCHORS_PREFIX=""

SHIPLOG_SIGN_EFFECTIVE=""
ALLOWED_AUTHORS_EFFECTIVE=""
SIGNERS_FILE_EFFECTIVE=""

# -------- Source Library Functions --------
[ -d "$LIB_DIR" ] || { echo "âŒ shiplog: unable to locate lib dir ($LIB_DIR)" >&2; exit 1; }

source "$LIB_DIR/common.sh"
source "$LIB_DIR/policy.sh"
source "$LIB_DIR/git.sh"
source "$LIB_DIR/commands.sh"

need git
if ! is_boring; then
  need "$GUM"
fi
need yq

export GIT_ALLOW_REFNAME_COMPONENTS_STARTING_WITH_DOT=1

run_with_global_flags() {
  local args=()
  while [ $# -gt 0 ]; do
    case "$1" in
      --boring)
        SHIPLOG_BORING=1
        export SHIPLOG_BORING
        shift
        ;;
      --help|-h)
        usage
        exit 0
        ;;
      --)
        shift
        args+=("$@")
        break
        ;;
      *)
        args+=("$1")
        shift
        args+=("$@")
        break
        ;;
    esac
  done
  if [ ${#args[@]} -eq 0 ]; then
    run_command
  else
    run_command "${args[@]}"
  fi
}

run_with_global_flags "$@"
